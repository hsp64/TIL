# 25년 8월 5일


---


# QueryDSL - 동적 쿼리 및 서브쿼리 학습, SQL - DDL과 DML 정리

## QueryDSL을 사용한 동적 쿼리(Dynamic Query)와 서브쿼리(Subquery)에 대해 학습하고 테스트 코드를 작성. 그룹별 평균 나이를 조회하는 API를 구현하고 이를 호출할 수 있도록 REST 컨트롤러도 구성

---

## 2. 주요 학습 내용

### 2.1 동적 쿼리 (QueryDslDynamicTest)

#### 2.1.1 BooleanBuilder 사용 이유

* 사용자 입력에 따라 조건이 달라지는 유동적인 WHERE 절을 구성하기 위해 사용한다.
* QueryDSL에서 제공하는 `BooleanBuilder`는 조건을 동적으로 추가할 수 있는 빌더 객체이다.

#### 2.1.2 코드 설명

```java
BooleanBuilder builder = new BooleanBuilder();
if (name != null) builder.and(idol.idolName.eq(name));
if (gender != null) builder.and(idol.gender.eq(gender));
if (minAge != null) builder.and(idol.age.goe(minAge));
if (maxAge != null) builder.and(idol.age.loe(maxAge));
```

* 조건이 null이 아닐 때만 `.and()`로 조건을 추가하여 동적으로 where 절을 구성한다.

---

### 2.2 동적 정렬

#### 2.2.1 OrderSpecifier 사용 이유

* 사용자의 입력에 따라 오름차순/내림차순 및 정렬 기준 컬럼을 다르게 하기 위해 필요하다.

#### 2.2.2 코드 설명

```java
OrderSpecifier<?> specifier = null;
switch (sortBy) {
    case "age" -> specifier = ascending ? idol.age.asc() : idol.age.desc();
    case "idolName" -> specifier = ascending ? idol.idolName.asc() : idol.idolName.desc();
    case "groupName" -> specifier = ascending ? idol.group.groupName.asc() : idol.group.groupName.desc();
}
```

* `switch` 문을 이용하여 정렬 조건을 다르게 설정하고, 해당 조건을 `.orderBy(specifier)`에 전달한다.

---

### 2.3 서브쿼리 (QueryDslSubqueryTest)

#### 2.3.1 평균 나이보다 나이 많은 아이돌

```java
.where(idol.age.gt(
    JPAExpressions.select(idol.age.avg())
        .from(idol)
        .where(idol.group.groupName.eq(groupName))
))
```

* 특정 그룹의 평균 나이를 서브쿼리로 계산하고, 그보다 나이가 많은 아이돌을 조회한다.

#### 2.3.2 그룹별 가장 최근 앨범

* 같은 그룹 내에서 `releaseYear`가 가장 큰 앨범을 조회하는 서브쿼리 구성

#### 2.3.3 특정 연도에 앨범 2개 이상 발매한 그룹

```java
JPAExpressions
    .select(album.group.id)
    .from(album)
    .where(album.releaseYear.eq(targetYear))
    .groupBy(album.group.id)
    .having(album.count().goe(2))
```

* group by, having을 활용하여 조건을 만족하는 그룹 ID만 추출하여 메인 쿼리에 사용한다.

#### 2.3.4 그룹이 없는 아이돌 조회

* `.where(JPAExpressions.select(group.id).where(group.id.eq(idol.group.id)).notExists())`

#### 2.3.5 특정 연도에 앨범이 없는 그룹

* `notExists()`를 활용하여 앨범이 없는 경우만 조회

---

### 2.4 평균 나이 API 구현

#### 2.4.1 컨트롤러

```java
@GetMapping("/avg")
public ResponseEntity<?> avg() {
    return ResponseEntity.ok().body(idolService.average());
}
```

#### 2.4.2 서비스

* Repository에서 QueryDSL로 조회한 평균 나이 결과를 그대로 반환

#### 2.4.3 Repository 구현

* `Projections.constructor()`를 사용하여 DTO로 매핑

---

## 3. 추가 설정

* `application.yml` 또는 `application.properties`에서 DDL 설정을 `create`에서 `update`로 변경하여 기존 데이터를 유지하면서 테스트 가능하게 구성함.

---

# SQL - DDL과 DML 정리

## 1. DDL (Data Definition Language) - 데이터 정의어

역할: 데이터베이스의 구조(스키마)를 정의하거나 수정할 때 사용

### 대표 명령어와 설명

| 명령어      | 설명                      |
| -------- | ----------------------- |
| CREATE   | 테이블, 데이터베이스, 인덱스 등을 생성  |
| ALTER    | 기존 테이블에 컬럼 추가/삭제/수정     |
| DROP     | 테이블이나 데이터베이스 삭제         |
| TRUNCATE | 테이블의 모든 데이터 삭제 (구조는 유지) |

### 사용 예시

```sql
CREATE TABLE members (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    age INT
);

ALTER TABLE members ADD COLUMN email VARCHAR(255);

DROP TABLE members;

TRUNCATE TABLE members;
```

### 특징

* 대부분의 DDL 명령은 자동 커밋(Auto Commit) 된다.
* 트랜잭션 롤백이 불가능한 경우가 많다.
* 테이블의 구조 자체에 영향을 미친다.

---

## 2. DML (Data Manipulation Language) - 데이터 조작어

역할: 테이블 안의 데이터를 조회, 추가, 수정, 삭제할 때 사용

### 대표 명령어와 설명

| 명령어    | 설명        |
| ------ | --------- |
| SELECT | 데이터 조회    |
| INSERT | 새 데이터 삽입  |
| UPDATE | 기존 데이터 수정 |
| DELETE | 기존 데이터 삭제 |

### 사용 예시

```sql
SELECT * FROM members;

INSERT INTO members (id, name, age) VALUES (1, '홍길동', 30);

UPDATE members SET age = 31 WHERE id = 1;

DELETE FROM members WHERE id = 1;
```

### 특징

* 트랜잭션 처리 가능 (커밋/롤백)
* WHERE 절 사용 시 조건을 만족하는 행만 선택적으로 처리 가능

---

## 3. DDL vs DML 요약 비교

| 구분         | DDL                           | DML                            |
| ---------- | ----------------------------- | ------------------------------ |
| 목적         | 데이터 구조 정의                     | 데이터 조작 (삽입, 수정 등)              |
| 대표 명령어     | CREATE, ALTER, DROP, TRUNCATE | SELECT, INSERT, UPDATE, DELETE |
| 트랜잭션 처리    | 자동 커밋됨                        | 수동 커밋 또는 롤백 가능                 |
| 영향을 미치는 대상 | 테이블/컬럼 구조                     | 테이블의 실제 데이터                    |

