# 25년 8월 16일


---

# 데이터베이스에서 **인증(Authentication)** 과 **인가(Authorization)**

오늘은 **DB 관점**에서의 인증·인가를 정리했습니다. 애플리케이션(Security, JWT) 레벨과 달리 **DB 자체가 접속자와 권한을 직접 통제**한다는 점이 핵심입니다.

---

## 0. 한눈에 개념 잡기

* **인증(Authentication)**: "너, 진짜 누구야?" — DB가 사용자의 **신원**을 확인
* **인가(Authorization)**: "뭘 할 수 있어?" — 인증된 사용자에게 **권한**을 부여/제한
* **원칙**: 최소 권한(Least Privilege), 역할(Role) 중심, 분리된 계정(운영/개발/마이그레이션)

> 비유: **백화점 VIP 라운지**
>
> * **인증**: 입구에서 신분증/멤버십 확인 (DB 로그인)
> * **인가**: 들어가서 어디까지 이용 가능한가? (라운지, 샤워실, 회의실 등 — SELECT/INSERT/UPDATE/DELETE/DDL 권한)

---

## 1. 왜 DB 레벨 권한이 필요한가

1. **방어선 중첩(Defense in Depth)**: 애플리케이션 권한이 뚫려도 DB가 2차 방어
2. **개발·운영 계정 분리**: 실수로 운영 데이터 대량 변경 방지
3. **감사/추적 용이**: 어떤 DB 계정이 무엇을 했는지 로그로 남김

---

## 2. 인증(Authentication) — DB가 "누구인지" 확인하는 법

### 2.1 계정과 호스트

* **MySQL/MariaDB**: `'user'@'host'` (예: `'app'@'10.0.%'`, `'admin'@'localhost'`)
* **PostgreSQL**: 롤(ROLE) + `pg_hba.conf`에서 접속 소스/IP/방식 지정
* **Oracle**: 사용자(User) + 프로파일(Profile)

### 2.2 암호화 및 인증 방식

* 전송 구간 암호화: **SSL/TLS** 사용 (클라이언트↔서버)
* 외부 인증: **LDAP/Kerberos/AD** 연동, 클라우드의 **IAM 인증(RDS 등)**
* 해시/플러그인

  * MySQL 8: `caching_sha2_password`(기본)
  * PostgreSQL: `SCRAM-SHA-256`

### 2.3 실습 예시 (MySQL/MariaDB)

```sql
-- 사용자 생성
CREATE USER 'app'@'10.0.%' IDENTIFIED BY 'StrongPwd!2025';
CREATE USER 'migrator'@'10.0.%' IDENTIFIED BY 'EvenStronger#2025';

-- 비밀번호 정책(예: MariaDB plugin 또는 MySQL validate_password 구성)
-- 서버 설정에서 길이/복잡도/만료 정책을 활성화하는 것을 권장
```

### 2.4 실습 예시 (PostgreSQL)

```sql
-- 롤 생성 (로그인 가능)
CREATE ROLE app LOGIN PASSWORD 'StrongPwd!2025';
CREATE ROLE migrator LOGIN PASSWORD 'EvenStronger#2025';

-- pg_hba.conf 에서 접속 허용/인증 방식 설정 후 reload 필요
```

> 팁: **운영**에서는 비밀번호를 코드에 박지 말고, **환경변수/시크릿 매니저**(AWS Secrets Manager 등)로 주입.

---

## 3. 인가(Authorization) — "무엇을 할 수 있는가"를 결정

### 3.1 권한의 층위

* **시스템 권한**: DB/스키마/사용자 생성 등 (위험, 운영자만)
* **오브젝트 권한**: 테이블/뷰/시퀀스 등 객체에 대한 SELECT/INSERT/UPDATE/DELETE/EXECUTE
* **롤(Role)**: 권한 묶음. 사용자에게 직접 권한을 주기보다 **롤을 부여**하는 게 표준

### 3.2 최소 권한 패턴(권장 롤)

* `app_rw` : 애플리케이션 **읽기/쓰기** (DDL 금지)
* `app_ro` : 대시보드/리포트 **읽기 전용**
* `migrator` : **스키마 변경(DDL)** 전용 (배포 도구: Flyway/Liquibase)

### 3.3 실습 예시 — MySQL/MariaDB

```sql
-- 1) 스키마 준비
CREATE DATABASE IF NOT EXISTS bookjuk CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 2) 롤(가상 롤: MariaDB는 ROLE 지원, MySQL 8도 ROLE 지원)
CREATE ROLE 'app_rw', 'app_ro', 'migrator';

-- 3) 권한을 롤에 부여
GRANT SELECT, INSERT, UPDATE, DELETE ON bookjuk.* TO 'app_rw';
GRANT SELECT                         ON bookjuk.* TO 'app_ro';
GRANT CREATE, ALTER, DROP, INDEX     ON bookjuk.* TO 'migrator';

-- 4) 사용자에게 롤 부여
GRANT 'app_rw' TO 'app'@'10.0.%';
GRANT 'migrator' TO 'migrator'@'10.0.%';

-- 5) 기본 활성 롤 설정 (MySQL 8+)
SET DEFAULT ROLE 'app_rw' FOR 'app'@'10.0.%';
SET DEFAULT ROLE 'migrator' FOR 'migrator'@'10.0.%';

-- 6) 검증
SHOW GRANTS FOR 'app'@'10.0.%';
```

> 주의: `GRANT ALL ON *.*` 나 `'%'` 호스트 와일드카드는 **최소화**. 운영망 범위만 열기.

### 3.4 실습 예시 — PostgreSQL

```sql
-- 1) 스키마와 롤
CREATE SCHEMA IF NOT EXISTS bookjuk;
CREATE ROLE app_rw NOINHERIT;
CREATE ROLE app_ro NOINHERIT;
CREATE ROLE migrator NOINHERIT;

-- 2) 롤에 권한 부여
GRANT USAGE ON SCHEMA bookjuk TO app_rw, app_ro, migrator;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA bookjuk TO app_rw;
GRANT SELECT                         ON ALL TABLES IN SCHEMA bookjuk TO app_ro;
GRANT CREATE, ALTER, TEMP            ON SCHEMA bookjuk TO migrator;

-- 3) 앞으로 생길 객체의 기본 권한(중요)
ALTER DEFAULT PRIVILEGES IN SCHEMA bookjuk GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_rw;
ALTER DEFAULT PRIVILEGES IN SCHEMA bookjuk GRANT SELECT ON TABLES TO app_ro;

-- 4) 사용자에게 롤 부여
GRANT app_rw TO app;
GRANT migrator TO migrator;
```

### 3.5 행 단위 보안(RLS)

* **PostgreSQL**은 **Row Level Security(RLS)** 지원: 사용자별/팀별 데이터 가시성 제어 가능

```sql
ALTER TABLE bookjuk.post ENABLE ROW LEVEL SECURITY;
CREATE POLICY post_owner_only ON bookjuk.post
USING (created_by = current_setting('app.user_id', true)::bigint);
```

* MySQL/MariaDB는 내장 RLS가 없어 **VIEW + DEFINER/INVOKER**로 제한을 우회 구현

---

## 4. 실무 설계 패턴 (Spring Boot + JPA 기준)

1. **DB 사용자 3종 세트**

   * `bj_api`(=app 사용자): DML만 (SELECT/INSERT/UPDATE/DELETE)
   * `bj_readonly`: SELECT 전용 (운영 점검/리포트)
   * `bj_migrator`: DDL 전용 (마이그레이션 툴이 사용)
2. **마이그레이션 툴**(Flyway/Liquibase)은 `bj_migrator`로 접속, 앱은 `bj_api`로 접속
3. **시크릿 관리**: `.env`/Vault/Secrets Manager로 주입, 깃에 올리지 않기
4. **네트워크**: VPC/보안그룹/방화벽으로 DB 접근 허용 IP 최소화 + **SSL 강제**
5. **권한 검증**: 앱 단(JWT, RBAC) + DB 단(최소 권한) **이중화**
6. **감사**: 쿼리 감사 로그(pgaudit, MariaDB audit plugin, RDS 로그) 활성화

### 예시 — MySQL로 BookJuk 운영 계정 구성

```sql
-- 롤
CREATE ROLE 'bj_app_rw', 'bj_app_ro', 'bj_migrator';
GRANT SELECT, INSERT, UPDATE, DELETE ON bookjuk.* TO 'bj_app_rw';
GRANT SELECT                         ON bookjuk.* TO 'bj_app_ro';
GRANT CREATE, ALTER, DROP, INDEX     ON bookjuk.* TO 'bj_migrator';

-- 사용자
CREATE USER 'bj_api'@'10.0.%' IDENTIFIED BY 'Xx#Api2025';
CREATE USER 'bj_readonly'@'10.0.%' IDENTIFIED BY 'Xx#Ro2025';
CREATE USER 'bj_migrator'@'10.0.%' IDENTIFIED BY 'Xx#Mig2025';

-- 부여
GRANT 'bj_app_rw' TO 'bj_api'@'10.0.%';
GRANT 'bj_app_ro' TO 'bj_readonly'@'10.0.%';
GRANT 'bj_migrator' TO 'bj_migrator'@'10.0.%';

SET DEFAULT ROLE 'bj_app_rw' FOR 'bj_api'@'10.0.%';
SET DEFAULT ROLE 'bj_app_ro' FOR 'bj_readonly'@'10.0.%';
SET DEFAULT ROLE 'bj_migrator' FOR 'bj_migrator'@'10.0.%';
```

---

## 5. 뷰·프로시저로 권한 좁히기

* **읽기 제한 뷰**: 민감 컬럼 마스킹/제외

```sql
CREATE VIEW v_post_public AS
SELECT id, title, SUBSTRING(content,1,200) AS preview, created_at
FROM post
WHERE is_private = 0;
GRANT SELECT ON v_post_public TO 'bj_readonly'@'10.0.%';
```

* **저장 프로시저**: 복잡한 DML을 캡슐화하고 테이블 직접 접근 제한

```sql
CREATE PROCEDURE approve_participant(IN p_meeting_id BIGINT, IN p_user_id BIGINT)
BEGIN
  UPDATE meeting_participant
    SET status = 'APPROVED', updated_at = NOW()
  WHERE meeting_id = p_meeting_id AND user_id = p_user_id;
END;
GRANT EXECUTE ON PROCEDURE approve_participant TO 'bj_api'@'10.0.%';
```

---

## 6. 점검/감사와 운영 팁

* **권한 점검**

```sql
-- MySQL
SHOW GRANTS FOR 'bj_api'@'10.0.%';

-- PostgreSQL: psql에서 \du, \dp
```

* **감사(Audit)**: pgaudit(Postgres), MariaDB Audit Plugin, CloudTrail/RDS 로그
* **비밀번호 로테이션**: 정기 교체 + 무중단 배포 전략(이중 시크릿, 롤링 재기동)

---

## 7. 트러블슈팅 FAQ

* *"권한 부여했는데 권한 없음 에러"* → 올바른 스키마/객체에 부여했는지, 접속 계정/호스트가 맞는지 확인. Postgres는 **DEFAULT PRIVILEGES** 누락 주의.
* *"새로 만든 테이블 접근 불가"* → MySQL은 `db.*`에 부여하면 신생 테이블 포함. Postgres는 `ALTER DEFAULT PRIVILEGES` 필수.
* *"운영에서 실수로 DDL 실행"* → DDL 권한을 앱 계정에서 제거. 마이그레이션 전용 계정만 보유.

---

## 8. 보안 체크리스트

* [ ] 운영망 이외 IP 차단, SSL 필수
* [ ] `GRANT ALL ON *.*` 금지, `%` 와일드카드 최소화
* [ ] 롤 기반 관리(사용자→롤, 롤→권한)
* [ ] 앱, 읽기전용, 마이그레이터 **계정 분리**
* [ ] 비밀번호 정책/로테이션, 시크릿 매니저 사용
* [ ] 감사 로그 활성화 + 정기 점검

---

## 9. 요약 한 줄

> **애플리케이션 권한(RBAC) + DB 최소 권한 롤 조합 + 네트워크/암호화/감사**를 함께 적용하면 DB 보안은 견고해진다.
