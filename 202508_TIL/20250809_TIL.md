# 25년 8월 9일


---

# Spring Security 인증/인가 TIL

## 🔍 인증(Authentication) vs 인가(Authorization)

### 인증 (Authentication)
- **"누가 접근하려고 하는가?"**
- 사용자가 실제로 그 사용자가 맞는지 확인하는 과정
- 예: 로그인 시 아이디/비밀번호 검증

### 인가 (Authorization)  
- **"이 사용자가 이 자원에 접근할 권한이 있는가?"**
- 인증된 사용자가 특정 리소스에 접근할 권한이 있는지 확인하는 과정
- 예: ADMIN 권한을 가진 사용자만 관리자 페이지 접근 가능

## 🛡️ Spring Security가 필요한 이유

1. **보안 표준화**: 검증된 보안 메커니즘 제공
2. **편의성**: 복잡한 보안 로직을 간단한 설정으로 구현
3. **확장성**: 다양한 인증 방식 지원 (JWT, OAuth2, LDAP 등)
4. **통합성**: Spring 생태계와의 완벽한 통합

## 🚀 Spring Security 기본 설정

### 1. 의존성 추가

```gradle
// build.gradle
implementation 'org.springframework.boot:spring-boot-starter-security'
implementation 'org.springframework.boot:spring-boot-starter-web'
```

### 2. 기본 Security 설정

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/public/**").permitAll()  // 공개 경로
                .requestMatchers("/admin/**").hasRole("ADMIN")  // 관리자만
                .anyRequest().authenticated()  // 나머지는 인증 필요
            )
            .formLogin(form -> form
                .loginPage("/login")  // 커스텀 로그인 페이지
                .defaultSuccessUrl("/dashboard")  // 로그인 성공 시 이동
                .permitAll()
            )
            .logout(logout -> logout
                .logoutUrl("/logout")
                .logoutSuccessUrl("/")
                .permitAll()
            );
        
        return http.build();
    }
}
```

### 3. 사용자 정보 설정

```java
@Service
public class UserDetailsServiceImpl implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new UsernameNotFoundException("사용자를 찾을 수 없습니다: " + username));
        
        return org.springframework.security.core.userdetails.User.builder()
            .username(user.getUsername())
            .password(user.getPassword())  // 암호화된 비밀번호
            .authorities(user.getRoles().stream()
                .map(role -> new SimpleGrantedAuthority("ROLE_" + role.getName()))
                .toList())
            .build();
    }
}
```

### 4. 비밀번호 암호화

```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    // 회원가입 시 비밀번호 암호화 예시
    @Service
    public class UserService {
        
        @Autowired
        private PasswordEncoder passwordEncoder;
        
        public void registerUser(String username, String rawPassword) {
            String encodedPassword = passwordEncoder.encode(rawPassword);
            // DB에 암호화된 비밀번호 저장
        }
    }
}
```

## 🎯 메소드 레벨 보안

### 1. @EnableMethodSecurity 활성화

```java
@Configuration
@EnableMethodSecurity(prePostEnabled = true)
public class MethodSecurityConfig {
}
```

### 2. 어노테이션 사용

```java
@RestController
public class UserController {
    
    @PreAuthorize("hasRole('ADMIN')")  // 실행 전 권한 체크
    @GetMapping("/admin/users")
    public List<User> getAllUsers() {
        return userService.findAll();
    }
    
    @PreAuthorize("hasRole('USER') and #userId == authentication.principal.id")
    @GetMapping("/users/{userId}")
    public User getUser(@PathVariable Long userId) {
        return userService.findById(userId);
    }
    
    @PostAuthorize("returnObject.owner == authentication.name")  // 실행 후 체크
    @GetMapping("/posts/{postId}")
    public Post getPost(@PathVariable Long postId) {
        return postService.findById(postId);
    }
}
```

## 🔐 JWT 기반 인증 구현

### 1. JWT 유틸리티 클래스

```java
@Component
public class JwtUtil {
    
    private String secretKey = "mySecretKey";
    
    public String generateToken(String username) {
        return Jwts.builder()
            .setSubject(username)
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + 86400000)) // 24시간
            .signWith(SignatureAlgorithm.HS256, secretKey)
            .compact();
    }
    
    public String extractUsername(String token) {
        return extractClaim(token, Claims::getSubject);
    }
    
    public boolean validateToken(String token, UserDetails userDetails) {
        final String username = extractUsername(token);
        return (username.equals(userDetails.getUsername()) && !isTokenExpired(token));
    }
}
```

### 2. JWT 필터

```java
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                  HttpServletResponse response, 
                                  FilterChain filterChain) throws ServletException, IOException {
        
        String authorizationHeader = request.getHeader("Authorization");
        
        if (authorizationHeader != null && authorizationHeader.startsWith("Bearer ")) {
            String token = authorizationHeader.substring(7);
            String username = jwtUtil.extractUsername(token);
            
            if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
                UserDetails userDetails = userDetailsService.loadUserByUsername(username);
                
                if (jwtUtil.validateToken(token, userDetails)) {
                    UsernamePasswordAuthenticationToken authToken = 
                        new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
                    SecurityContextHolder.getContext().setAuthentication(authToken);
                }
            }
        }
        
        filterChain.doFilter(request, response);
    }
}
```

## 🎨 커스텀 로그인 페이지

```html
<!-- login.html -->
<!DOCTYPE html>
<html>
<head>
    <title>로그인</title>
</head>
<body>
    <form th:action="@{/login}" method="post">
        <div>
            <label>사용자명: <input type="text" name="username"/></label>
        </div>
        <div>
            <label>비밀번호: <input type="password" name="password"/></label>
        </div>
        <div>
            <input type="submit" value="로그인"/>
        </div>
    </form>
</body>
</html>
```

## 📝 실전 활용 팁

### 1. 현재 로그인한 사용자 정보 가져오기

```java
@GetMapping("/profile")
public ResponseEntity<?> getProfile(Authentication authentication) {
    String username = authentication.getName();
    // 또는
    UserDetails userDetails = (UserDetails) authentication.getPrincipal();
    return ResponseEntity.ok(userService.findByUsername(username));
}

// 또는 @AuthenticationPrincipal 사용
@GetMapping("/profile2")
public ResponseEntity<?> getProfile2(@AuthenticationPrincipal UserDetails userDetails) {
    return ResponseEntity.ok(userService.findByUsername(userDetails.getUsername()));
}
```

### 2. CSRF 비활성화 (API 개발 시)

```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())  // REST API에서는 보통 비활성화
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))  // JWT 사용 시
            // ... 기타 설정
            ;
        return http.build();
    }
}
```

### 3. CORS 설정

```java
@Configuration
public class CorsConfig {
    
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOriginPatterns(Arrays.asList("*"));
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE"));
        configuration.setAllowedHeaders(Arrays.asList("*"));
        configuration.setAllowCredentials(true);
        
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}
```

## 🚨 보안 주의사항

1. **비밀번호는 반드시 암호화하여 저장**
2. **JWT 시크릿 키는 환경변수로 관리**
3. **HTTPS 사용 권장**
4. **세션 타임아웃 설정**
5. **브루트 포스 공격 방지**


---
*작성일: 2025-08-09*  
*키워드: #SpringSecurity #인증 #인가 #JWT #보안*
