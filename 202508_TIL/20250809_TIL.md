# 25ë…„ 8ì›” 9ì¼


---

# Spring Security ì¸ì¦/ì¸ê°€ TIL

## ğŸ” ì¸ì¦(Authentication) vs ì¸ê°€(Authorization)

### ì¸ì¦ (Authentication)
- **"ëˆ„ê°€ ì ‘ê·¼í•˜ë ¤ê³  í•˜ëŠ”ê°€?"**
- ì‚¬ìš©ìê°€ ì‹¤ì œë¡œ ê·¸ ì‚¬ìš©ìê°€ ë§ëŠ”ì§€ í™•ì¸í•˜ëŠ” ê³¼ì •
- ì˜ˆ: ë¡œê·¸ì¸ ì‹œ ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ê²€ì¦

### ì¸ê°€ (Authorization)  
- **"ì´ ì‚¬ìš©ìê°€ ì´ ìì›ì— ì ‘ê·¼í•  ê¶Œí•œì´ ìˆëŠ”ê°€?"**
- ì¸ì¦ëœ ì‚¬ìš©ìê°€ íŠ¹ì • ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ê³¼ì •
- ì˜ˆ: ADMIN ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìë§Œ ê´€ë¦¬ì í˜ì´ì§€ ì ‘ê·¼ ê°€ëŠ¥

## ğŸ›¡ï¸ Spring Securityê°€ í•„ìš”í•œ ì´ìœ 

1. **ë³´ì•ˆ í‘œì¤€í™”**: ê²€ì¦ëœ ë³´ì•ˆ ë©”ì»¤ë‹ˆì¦˜ ì œê³µ
2. **í¸ì˜ì„±**: ë³µì¡í•œ ë³´ì•ˆ ë¡œì§ì„ ê°„ë‹¨í•œ ì„¤ì •ìœ¼ë¡œ êµ¬í˜„
3. **í™•ì¥ì„±**: ë‹¤ì–‘í•œ ì¸ì¦ ë°©ì‹ ì§€ì› (JWT, OAuth2, LDAP ë“±)
4. **í†µí•©ì„±**: Spring ìƒíƒœê³„ì™€ì˜ ì™„ë²½í•œ í†µí•©

## ğŸš€ Spring Security ê¸°ë³¸ ì„¤ì •

### 1. ì˜ì¡´ì„± ì¶”ê°€

```gradle
// build.gradle
implementation 'org.springframework.boot:spring-boot-starter-security'
implementation 'org.springframework.boot:spring-boot-starter-web'
```

### 2. ê¸°ë³¸ Security ì„¤ì •

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/public/**").permitAll()  // ê³µê°œ ê²½ë¡œ
                .requestMatchers("/admin/**").hasRole("ADMIN")  // ê´€ë¦¬ìë§Œ
                .anyRequest().authenticated()  // ë‚˜ë¨¸ì§€ëŠ” ì¸ì¦ í•„ìš”
            )
            .formLogin(form -> form
                .loginPage("/login")  // ì»¤ìŠ¤í…€ ë¡œê·¸ì¸ í˜ì´ì§€
                .defaultSuccessUrl("/dashboard")  // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì´ë™
                .permitAll()
            )
            .logout(logout -> logout
                .logoutUrl("/logout")
                .logoutSuccessUrl("/")
                .permitAll()
            );
        
        return http.build();
    }
}
```

### 3. ì‚¬ìš©ì ì •ë³´ ì„¤ì •

```java
@Service
public class UserDetailsServiceImpl implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new UsernameNotFoundException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + username));
        
        return org.springframework.security.core.userdetails.User.builder()
            .username(user.getUsername())
            .password(user.getPassword())  // ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸
            .authorities(user.getRoles().stream()
                .map(role -> new SimpleGrantedAuthority("ROLE_" + role.getName()))
                .toList())
            .build();
    }
}
```

### 4. ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”

```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    // íšŒì›ê°€ì… ì‹œ ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ì˜ˆì‹œ
    @Service
    public class UserService {
        
        @Autowired
        private PasswordEncoder passwordEncoder;
        
        public void registerUser(String username, String rawPassword) {
            String encodedPassword = passwordEncoder.encode(rawPassword);
            // DBì— ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸ ì €ì¥
        }
    }
}
```

## ğŸ¯ ë©”ì†Œë“œ ë ˆë²¨ ë³´ì•ˆ

### 1. @EnableMethodSecurity í™œì„±í™”

```java
@Configuration
@EnableMethodSecurity(prePostEnabled = true)
public class MethodSecurityConfig {
}
```

### 2. ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©

```java
@RestController
public class UserController {
    
    @PreAuthorize("hasRole('ADMIN')")  // ì‹¤í–‰ ì „ ê¶Œí•œ ì²´í¬
    @GetMapping("/admin/users")
    public List<User> getAllUsers() {
        return userService.findAll();
    }
    
    @PreAuthorize("hasRole('USER') and #userId == authentication.principal.id")
    @GetMapping("/users/{userId}")
    public User getUser(@PathVariable Long userId) {
        return userService.findById(userId);
    }
    
    @PostAuthorize("returnObject.owner == authentication.name")  // ì‹¤í–‰ í›„ ì²´í¬
    @GetMapping("/posts/{postId}")
    public Post getPost(@PathVariable Long postId) {
        return postService.findById(postId);
    }
}
```

## ğŸ” JWT ê¸°ë°˜ ì¸ì¦ êµ¬í˜„

### 1. JWT ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤

```java
@Component
public class JwtUtil {
    
    private String secretKey = "mySecretKey";
    
    public String generateToken(String username) {
        return Jwts.builder()
            .setSubject(username)
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + 86400000)) // 24ì‹œê°„
            .signWith(SignatureAlgorithm.HS256, secretKey)
            .compact();
    }
    
    public String extractUsername(String token) {
        return extractClaim(token, Claims::getSubject);
    }
    
    public boolean validateToken(String token, UserDetails userDetails) {
        final String username = extractUsername(token);
        return (username.equals(userDetails.getUsername()) && !isTokenExpired(token));
    }
}
```

### 2. JWT í•„í„°

```java
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                  HttpServletResponse response, 
                                  FilterChain filterChain) throws ServletException, IOException {
        
        String authorizationHeader = request.getHeader("Authorization");
        
        if (authorizationHeader != null && authorizationHeader.startsWith("Bearer ")) {
            String token = authorizationHeader.substring(7);
            String username = jwtUtil.extractUsername(token);
            
            if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
                UserDetails userDetails = userDetailsService.loadUserByUsername(username);
                
                if (jwtUtil.validateToken(token, userDetails)) {
                    UsernamePasswordAuthenticationToken authToken = 
                        new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
                    SecurityContextHolder.getContext().setAuthentication(authToken);
                }
            }
        }
        
        filterChain.doFilter(request, response);
    }
}
```

## ğŸ¨ ì»¤ìŠ¤í…€ ë¡œê·¸ì¸ í˜ì´ì§€

```html
<!-- login.html -->
<!DOCTYPE html>
<html>
<head>
    <title>ë¡œê·¸ì¸</title>
</head>
<body>
    <form th:action="@{/login}" method="post">
        <div>
            <label>ì‚¬ìš©ìëª…: <input type="text" name="username"/></label>
        </div>
        <div>
            <label>ë¹„ë°€ë²ˆí˜¸: <input type="password" name="password"/></label>
        </div>
        <div>
            <input type="submit" value="ë¡œê·¸ì¸"/>
        </div>
    </form>
</body>
</html>
```

## ğŸ“ ì‹¤ì „ í™œìš© íŒ

### 1. í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°

```java
@GetMapping("/profile")
public ResponseEntity<?> getProfile(Authentication authentication) {
    String username = authentication.getName();
    // ë˜ëŠ”
    UserDetails userDetails = (UserDetails) authentication.getPrincipal();
    return ResponseEntity.ok(userService.findByUsername(username));
}

// ë˜ëŠ” @AuthenticationPrincipal ì‚¬ìš©
@GetMapping("/profile2")
public ResponseEntity<?> getProfile2(@AuthenticationPrincipal UserDetails userDetails) {
    return ResponseEntity.ok(userService.findByUsername(userDetails.getUsername()));
}
```

### 2. CSRF ë¹„í™œì„±í™” (API ê°œë°œ ì‹œ)

```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())  // REST APIì—ì„œëŠ” ë³´í†µ ë¹„í™œì„±í™”
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))  // JWT ì‚¬ìš© ì‹œ
            // ... ê¸°íƒ€ ì„¤ì •
            ;
        return http.build();
    }
}
```

### 3. CORS ì„¤ì •

```java
@Configuration
public class CorsConfig {
    
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOriginPatterns(Arrays.asList("*"));
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE"));
        configuration.setAllowedHeaders(Arrays.asList("*"));
        configuration.setAllowCredentials(true);
        
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}
```

## ğŸš¨ ë³´ì•ˆ ì£¼ì˜ì‚¬í•­

1. **ë¹„ë°€ë²ˆí˜¸ëŠ” ë°˜ë“œì‹œ ì•”í˜¸í™”í•˜ì—¬ ì €ì¥**
2. **JWT ì‹œí¬ë¦¿ í‚¤ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬**
3. **HTTPS ì‚¬ìš© ê¶Œì¥**
4. **ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ ì„¤ì •**
5. **ë¸Œë£¨íŠ¸ í¬ìŠ¤ ê³µê²© ë°©ì§€**


---
*ì‘ì„±ì¼: 2025-08-09*  
*í‚¤ì›Œë“œ: #SpringSecurity #ì¸ì¦ #ì¸ê°€ #JWT #ë³´ì•ˆ*
